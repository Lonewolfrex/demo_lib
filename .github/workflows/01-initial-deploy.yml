name: 01 - Initial App Deployment

on:
  push:
    branches: [ main, dev, v1, feature/** ]

jobs:
  initial-deploy:
    runs-on: self-hosted

    env:
      IMAGE_NAME: "book-library-app"
      IMAGE_TAG: "${{ github.sha }}"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Docker version
        run: docker version

      - name: Build Docker image
        run: |
          docker build -t "$env:IMAGE_NAME`:$env:IMAGE_TAG" .

      - name: Run app container
        id: run_container
        run: |
          $CONTAINER_ID = docker run -d -p 8001:8001 "$env:IMAGE_NAME`:$env:IMAGE_TAG"
          Write-Host "Container started: $CONTAINER_ID"
          echo "container_id=$CONTAINER_ID" >> $env:GITHUB_OUTPUT

      - name: Wait for app to be ready
        run: |
          $loginUrl = "http://localhost:8001/login/"
          $maxAttempts = 10
          $attempt = 1
          while ($attempt -le $maxAttempts) {
            Write-Host "Checking app health at $loginUrl (attempt $attempt/$maxAttempts)..."
            try {
              $resp = Invoke-WebRequest -Uri $loginUrl -Method GET -UseBasicParsing -TimeoutSec 5
              if ($resp.StatusCode -eq 200) {
                Write-Host "App is up."
                break
              }
            } catch {
              Write-Host "App not ready yet: $($_.Exception.Message)"
            }
            Start-Sleep -Seconds 3
            $attempt++
          }
          if ($attempt -gt $maxAttempts) {
            throw "App did not become ready in time."
          }
